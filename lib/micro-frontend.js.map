{"version":3,"file":"micro-frontend.js","sources":["../src/application/state.js","../src/start.js","../src/utils.js","../src/application/timeout.js","../src/lifecyle/load.js","../src/lifecyle/unmount.js","../src/lifecyle/mount.js","../src/lifecyle/bootstrap.js","../src/navigation/interceptor.js","../src/navigation/invoke.js","../src/application/app.js"],"sourcesContent":["export const NOT_LOADED = \"NOT_LOADED\"\nexport const LOAD_SOURCE_CODE = 'LOAD_SOURCE_CODE'\nexport const NOT_BOOTSTRAPED = 'NOT_BOOTSTRAPED'\nexport const BOOTSTRAPING = 'BOOTSTRAPING'\nexport const NOT_MOUNTED = 'NOT_MOUNTED'\nexport const MOUNTING = 'MOUNTING'\nexport const MOUNTED = 'MOUNTED'\nexport const UNMOUNTING = 'UNMOUNTING'\n\nexport const SKIP_BECAUSE_BROKEN = 'SKIP_BECAUSE_BROKEN'\nexport const LOAD_ERROR = 'LOAD_ERROR'\n\n\n\nexport function noSkip(app) {\n    return app.status !== SKIP_BECAUSE_BROKEN;\n}\n\nexport function noLoadError(app) {\n    return app.status !== LOAD_ERROR\n}\n\nexport function isntLoaded(app) {\n    return !isLoaded(app)\n}\n\nexport function isLoaded(app) {\n    return app.status !== NOT_LOADED && app.status !== LOAD_ERROR\n}\n\nexport function shouldBeActivity(app) {\n    try {\n        return app.activityWhen(window.location)\n    } catch (error) {\n        app.status = SKIP_BECAUSE_BROKEN\n        throw error;\n    }\n}\n\nexport function isActive(app) {\n    return app.status === MOUNTED\n}\n\nexport function isntActive(app) {\n    return !isActive(app)\n}\n\nexport function shouldntBeActive(app) {\n    try {\n        return !app.activityWhen(window.location)\n    } catch (error) {\n        app.status = SKIP_BECAUSE_BROKEN\n        throw error;\n    }\n}","import { invoke } from \"./navigation/invoke\"\n\nlet started = false\n\n\nexport function start() {\n    started = true\n    return invoke()\n}\n\nexport function isStarted() {\n    return started\n}","\nexport const isArray = Array.isArray\n\nexport const isPromise = (promise) => {\n    if (promise instanceof Promise) {\n        return true\n    }\n\n    return typeof promise === 'object' && typeof promise.then === 'function';\n}\n\nexport function flattenPromiseArray(promises) {\n    if (!isArray(promises)) {\n        promises = [promises]\n    }\n    if (promises.length === 0) {\n        promises = [() => Promise.resolve()];\n    }\n    return function (props) {\n        return new Promise((resolve, reject) => {\n            waitForPromises(0)\n            function waitForPromises(index) {\n                let fn = promises[index](props);\n                fn.then(() => {\n                    if (index >= promises.length - 1) {\n                        resolve()\n                    } else {\n                        waitForPromises(++index)\n                    }\n                }).catch(reject)\n            }\n        })\n\n    }\n}","/**\n * promise 队列超时响应\n */\n\nconst DEFAULT_TIMEOUT = {\n    bootstrap: {\n        milliseconds: 3000,\n        rejectwhenTimeout: false\n    },\n    mount: {\n        milliseconds: 3000,\n        rejectwhenTimeout: false,\n    },\n    unmount: {\n        milliseconds: 3000,\n        rejectwhenTimeout: false\n    },\n    unload: {\n        milliseconds: 3000,\n        rejectwhenTimeout:false\n    }\n}\n\nexport function ensureAppTimeouts(timeouts) {\n    return {\n        ...DEFAULT_TIMEOUT,\n        ...timeouts\n    }\n}\n\n\nexport function reasonableTime(promise, timeouts) {\n\n    return new Promise((resolve, reject) => {\n        let finished = false;\n        promise.then(data => {\n            finished = true;\n            resolve(data);\n        }).catch(e => {\n            finished = true;\n            reject(e);\n        });\n\n        setTimeout(() => maybeTimeout(), timeouts.milliseconds)\n        function maybeTimeout() {\n            if (finished) {\n                return;\n            }\n            let error = `${description} did not resolve or reject for ${timeouts.milliseconds} milliseconds`;\n            if (timeouts.rejectWhenTimeout) {\n                reject(new Error(error));\n            } else {\n                console.warn(error);\n            }\n        }\n    })\n}","import { NOT_LOADED, SKIP_BECAUSE_BROKEN, LOAD_SOURCE_CODE, NOT_BOOTSTRAPED, LOAD_ERROR } from \"../application/state\";\nimport { isPromise, flattenPromiseArray } from \"../utils\";\nimport { getProps } from \"../application/app\";\nimport { ensureAppTimeouts } from \"../application/timeout\";\nconst lifecyleHooks = ['bootstrap', 'mount', 'unmount']\n\nexport function toLoadPromise(app) {\n    if (app.status !== NOT_LOADED) {\n        return Promise.resolve(app)\n    }\n    // 下载代码阶段\n    app.status = LOAD_SOURCE_CODE;\n    const loadPromise = app.loadApp(getProps(app))\n\n    if (!isPromise(loadPromise)) {\n        app.status = SKIP_BECAUSE_BROKEN\n        return Promise.reject(new Error('loadApp is not a Promise'));\n    }\n    const errors = []\n    return loadPromise.then(appConfig => {\n        lifecyleHooks.forEach(lifecyle => {\n            if (!appConfig[lifecyle]) {\n                errors.push(`lifecyle: ${lifecyle} is not exist`)\n            }\n        })\n\n        if (errors.length) {\n            app.status === SKIP_BECAUSE_BROKEN\n            throw new Error(errors)\n        }\n\n        app.status = NOT_BOOTSTRAPED;\n        app.bootstrap = flattenPromiseArray(appConfig.bootstrap);\n        app.mount = flattenPromiseArray(appConfig.mount);\n        app.unmount = flattenPromiseArray(appConfig.unmount);\n\n        app.timeouts = ensureAppTimeouts(appConfig.timeouts)\n        return app;\n    }).catch(error => {\n        console.log(error)\n        app.status = LOAD_ERROR\n        return app\n    })\n}","import { MOUNTED, UNMOUNTING, SKIP_BECAUSE_BROKEN, NOT_MOUNTED } from \"../application/state\";\nimport { reasonableTime } from \"../application/timeout\";\nimport { getProps } from \"../application/app\";\n\nexport function toUnmountPromise(app) {\n    if (app.status !== MOUNTED) {\n        return Promise.resolve(app)\n    }\n    app.status = UNMOUNTING\n    return reasonableTime(app.unmount(getProps(app)), app.timeouts.unmount).then(() => {\n        app.status = NOT_MOUNTED\n    }).catch(error => {\n        app.status = SKIP_BECAUSE_BROKEN;\n        throw error\n    })\n\n}","import { NOT_MOUNTED, MOUNTING, SKIP_BECAUSE_BROKEN, MOUNTED } from \"../application/state\";\nimport { reasonableTime } from \"../application/timeout\";\nimport { getProps } from \"../application/app\";\nimport { toUnmountPromise } from \"./unmount\";\n\n\nexport function toMountPromise(app) {\n    if (app.status !== NOT_MOUNTED) {\n        return Promise.resolve(app)\n    }\n    app.status = MOUNTING\n\n    return reasonableTime(app.mount(getProps(app)), app.timeouts.mount).then(() => {\n        app.status = MOUNTED\n        return app\n    }).catch(error => {\n        app.status = MOUNTED\n        // 如果挂在失败  立即执行unmount\n        return toUnmountPromise(app)\n        .catch(()=>{\n            console.log(error)\n        }).then(() => {\n            app.status = SKIP_BECAUSE_BROKEN\n            return app\n        })\n    })\n\n}","import { NOT_BOOTSTRAPED, BOOTSTRAPING, SKIP_BECAUSE_BROKEN, NOT_MOUNTED } from \"../application/state\";\nimport { reasonableTime } from \"../application/timeout\";\nimport { getProps } from \"../application/app\";\n\nexport function toBootstrapPromise(app) {\n    if (app.status !== NOT_BOOTSTRAPED) {\n        return Promise.resolve(app)\n    }\n    app.status = BOOTSTRAPING\n    return reasonableTime(app.bootstrap(getProps(app)), app.timeouts.bootstrap).then(() => {\n        app.status = NOT_MOUNTED\n        return app\n    }).catch(error => {\n        console.log(error)\n        app.status = SKIP_BECAUSE_BROKEN\n        throw error;\n    })\n\n}","import { invoke } from \"./invoke\";\n\n\nconst EVENT_NAME = /^(hashchange|popstate)$/i;\n\nconst EVENTS_POOL = {\n    hashchange: [],\n    popstate: []\n};\n\n\nfunction reroute(...args) {\n    invoke([], args)\n}\n\n\nwindow.addEventListener('hashchange', reroute)\nwindow.addEventListener('popstate', reroute)\n\n// 拦截\n\nconst originalAddEventListener = window.addEventListener;\nconst originalRemoveEventListener = window.removeEventListener;\n\nwindow.addEventListener = function (eventName, handler, args) {\n    if (eventName && EVENT_NAME.test(eventName) && typeof handler === 'function') {\n        EVENTS_POOL[eventName].indexOf(handler) === -1 && EVENTS_POOL[eventName].push(handler);\n    }\n    return originalAddEventListener.apply(this, arguments);\n}\nwindow.removeEventListener = function (eventName, handler) {\n    if (eventName && HIJACK_EVENTS_NAME.test(eventName) && typeof handler === 'function') {\n        let eventList = EVENTS_POOL[eventName];\n        eventList.indexOf(handler) > -1 && (EVENTS_POOL[eventName] = eventList.filter(fn => fn !== handler));\n    }\n    return originalRemoveEventListener.apply(this, arguments);\n};\n\n\nconst originalHistoryPushState = window.history.pushState;\nconst originalHistoryReplaceState = window.history.replaceState;\n\n\nwindow.history.pushState = function (state, title, url) {\n    let result = originalHistoryPushState.apply(this, arguments);\n    reroute(mockPopStateEvent(state));\n    return result;\n};\nwindow.history.replaceState = function (state, title, url) {\n    let result = originalHistoryReplaceState.apply(this, arguments);\n    reroute(mockPopStateEvent(state));\n    return result;\n};\n\nfunction mockPopStateEvent(state) {\n    return new PopStateEvent('popstate', { state });\n}\n\nexport function callCapturedEvents(eventArgs) {\n    if (!eventArgs) {\n        return;\n    }\n    if (Array.isArray(eventArgs)) {\n        eventArgs = eventArgs[0];\n    }\n    let name = eventArgs.type;\n    if (!EVENT_NAME.test(name)) {\n        return;\n    }\n    EVENTS_POOL[name].forEach(handler => handler.apply(window, eventArgs));\n}","import { isStarted } from \"../start\"\nimport { getAppsToLoad, getAppsToUnmount, getAppsToMount, getMountedApps } from \"../application/app\"\nimport { toLoadPromise } from '../lifecyle/load'\nimport { toMountPromise } from \"../lifecyle/mount\"\nimport { toBootstrapPromise } from \"../lifecyle/bootstrap\"\nimport { toUnmountPromise } from '../lifecyle/unmount'\nimport {callCapturedEvents} from './interceptor'\n\n\n\nlet appChangeUnderway = false\nlet changesQueue = []\n\nexport function invoke(pendings = [], eventArgs) {\n    if (appChangeUnderway) {\n        return new Promise((resolve, reject) => {\n            changesQueue.push({\n                success: resolve,\n                failure: reject\n            })\n        })\n    }\n    appChangeUnderway = true\n    if (isStarted()) {\n        return performAppsChanged()\n    }\n    return loadApps()\n\n\n\n    function loadApps() {\n        const loadPromises = getAppsToLoad().map(toLoadPromise)\n        Promise.all(loadPromises).then(() => {\n            callAllLocationEvents()\n            return finish()\n        }).catch(e => {\n            callAllLocationEvents();\n            console.log(e)\n        })\n    }\n\n    function performAppsChanged() {\n        //unmount\n        const unmountApps = getAppsToUnmount()\n        const unmountPromise = Promise.all(unmountApps.map(toUnmountPromise))\n\n        // load\n        const loadApps = getAppsToLoad()\n        const loadPromises = loadApps.map(app => {\n            return toLoadPromise(app)\n                .then(toBootstrapPromise)\n                .then(() => unmountPromise)\n                .then(() => toMountPromise(app))\n        })\n\n        // mount app\n        let mountApps = getAppsToMount().filter(app => loadApps.indexOf(app) === -1);\n        const mountPromises = mountApps.map(app => {\n            return toBootstrapPromise(app)\n                .then(() => unmountPromise)\n                .then(() => toMountPromise(app))\n        })\n\n        unmountPromise.then(() => {\n            callAllLocationEvents();\n            let loadAndMountPromises = loadPromises.concat(mountPromises);\n            return Promise.all(loadAndMountPromises).then(finish, ex => {\n                pendings.forEach(item => item.reject(ex));\n                throw ex;\n            });\n        }).catch(e => {\n            callAllLocationEvents();\n            console.log(e);\n            throw e;\n        })\n    }\n\n    function finish() {\n        let resolveValue = getMountedApps()\n        if (pendings.length) {\n            pendings.forEach(item => item.success(resolveValue))\n        }\n\n        appChangeUnderway = false\n        if (changesQueue.length) {\n            let backup = changesQueue;\n            changesQueue = []\n            return invoke(backup)\n        }\n\n        return resolveValue\n    }\n\n\n    function callAllLocationEvents() {\n        pendings && pendings.length && pendings.filter(item => item.eventArgs).forEach(item => callCapturedEvents(item.eventArgs));\n        eventArgs && callCapturedEvents(eventArgs);\n    }\n}","import {\n    NOT_LOADED,\n    noSkip,\n    noLoadError,\n    isntLoaded,\n    shouldBeActivity,\n    isActive,\n    shouldntBeActive,\n    isLoaded,\n    isntActive\n} from './state'\nimport { invoke } from '../navigation/invoke'\n\nconst APPS = []\n\nexport function registerApplication(appName, applicationOrLoadFunction, activityWhen, customProps) {\n    if (typeof applicationOrLoadFunction !== 'function') {\n        applicationOrLoadFunction = () => Promise.resolve(applicationOrLoadFunction)\n    }\n\n    APPS.push({\n        name: appName,\n        loadApp: applicationOrLoadFunction,\n        activityWhen,\n        status: NOT_LOADED,\n        customProps\n    })\n\n    return invoke()\n}\n\n\nexport function getAppsToLoad() {\n    return APPS.filter(noSkip)\n        .filter(noLoadError)\n        .filter(isntLoaded)\n        .filter(shouldBeActivity)\n}\n\nexport function getAppsToUnmount() {\n    return APPS.filter(noSkip)\n        .filter(isActive)\n        .filter(shouldntBeActive)\n}\n\n\nexport function getAppsToMount() {\n    return APPS.filter(noSkip)\n        .filter(isLoaded)\n        .filter(isntActive)\n        .filter(shouldBeActivity)\n}\n\n\nexport function getMountedApps(){\n    return APPS.filter(isActive).map(item => item.name);\n}\n\n\nexport function getProps(app) {\n    return {\n        name: app.name,\n        ...app.customProps\n    }\n}\n\n"],"names":["NOT_LOADED","LOAD_SOURCE_CODE","NOT_BOOTSTRAPED","BOOTSTRAPING","NOT_MOUNTED","MOUNTING","MOUNTED","UNMOUNTING","SKIP_BECAUSE_BROKEN","LOAD_ERROR","noSkip","app","status","noLoadError","isntLoaded","isLoaded","shouldBeActivity","activityWhen","window","location","error","isActive","isntActive","shouldntBeActive","started","start","invoke","isStarted","isArray","Array","isPromise","promise","Promise","then","flattenPromiseArray","promises","length","resolve","props","reject","waitForPromises","index","fn","catch","DEFAULT_TIMEOUT","bootstrap","milliseconds","rejectwhenTimeout","mount","unmount","unload","ensureAppTimeouts","timeouts","reasonableTime","finished","data","e","setTimeout","maybeTimeout","description","rejectWhenTimeout","Error","console","warn","lifecyleHooks","toLoadPromise","loadPromise","loadApp","getProps","errors","appConfig","forEach","lifecyle","push","log","toUnmountPromise","toMountPromise","toBootstrapPromise","EVENT_NAME","EVENTS_POOL","hashchange","popstate","reroute","args","addEventListener","originalAddEventListener","originalRemoveEventListener","removeEventListener","eventName","handler","test","indexOf","apply","arguments","HIJACK_EVENTS_NAME","eventList","filter","originalHistoryPushState","history","pushState","originalHistoryReplaceState","replaceState","state","title","url","result","mockPopStateEvent","PopStateEvent","callCapturedEvents","eventArgs","name","type","appChangeUnderway","changesQueue","pendings","success","failure","performAppsChanged","loadApps","loadPromises","getAppsToLoad","map","all","callAllLocationEvents","finish","unmountApps","getAppsToUnmount","unmountPromise","mountApps","getAppsToMount","mountPromises","loadAndMountPromises","concat","ex","item","resolveValue","getMountedApps","backup","APPS","registerApplication","appName","applicationOrLoadFunction","customProps"],"mappings":"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"}